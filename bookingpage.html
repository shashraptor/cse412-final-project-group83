<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Book Your Flight</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
</head>
<body>
    <h1>Flight Booking System</h1>
    
    <form id="bookingForm">
        <div class="form-group">
            <label for="flightSelect">Choose a Flight</label>
            <select id="flightSelect" name="flightId" required>
                <option value="">Select a Flight</option>
                {% for flight in flights %}
                <option value="{{ flight[0] }}">
                    FlightId: {{ flight[0] }} | {{ flight[6] }} to {{ flight[7] }} | 
                    Departs: {{ flight[2] }} | Arrives: {{ flight[3] }} | 
                    Date: {{ flight[1] }}
                </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            <label for="seatSelect">Choose a Seat</label>
            <select id="seatSelect" name="seatId" required disabled>
                <option value="">Select a Seat</option>
            </select>
        </div>

        <div class="form-group">
            <label for="paymentMethod">Payment Method</label>
            <select id="paymentMethod" name="paymentMethod" required>
                <option value="">Select Payment Method</option>
                <option value="PayPal">PayPal</option>
                <option value="Credit Card">Credit Card</option>
            </select>
        </div>

        <div class="form-group">
            <label for="totalPrice">Total Price</label>
            <input type="text" id="totalPrice" readonly>
        </div>

        <button type="submit">Confirm Booking</button>
    </form>

    <script>
    $(document).ready(function() {
        // Price mapping based on seat class
        const seatPrices = {
            'First': 600,
            'Business': 450,
            'Economy': 300
        };

        $('#flightSelect').change(function() {
            var flightId = $(this).val();
            
            if (flightId) {
                $.ajax({
                    url: '/get_seats/' + flightId,
                    type: 'GET',
                    success: function(response) {
                        var seatSelect = $('#seatSelect');
                        seatSelect.empty();
                        seatSelect.append('<option value="">Select a Seat</option>');
                        
                        response.seats.forEach(function(seat) {
                            seatSelect.append(
                                '<option value="' + seat.seatNum + '" data-class="' + seat.class + '">' + 
                                'Seat: ' + seat.seatNum + ' | Class: ' + seat.class + 
                                '</option>'
                            );
                        });
                        
                        seatSelect.prop('disabled', false);
                    }
                });
            } else {
                $('#seatSelect').prop('disabled', true).empty().append('<option value="">Select a Seat</option>');
                $('#totalPrice').val('');
            }
        });

        $('#seatSelect').change(function() {
            var selectedOption = $(this).find(':selected');
            var seatClass = selectedOption.data('class');
            
            if (seatClass) {
                var price = seatPrices[seatClass] || 0;
                $('#totalPrice').val('$' + price);
            } else {
                $('#totalPrice').val('');
            }
        });

        $('#bookingForm').submit(function(e) {
            e.preventDefault();
            
            if (!$('#flightSelect').val() || !$('#seatSelect').val() || !$('#paymentMethod').val()) {
                alert('Please fill in all fields');
                return;
            }

            $.ajax({
                url: '/book_flight',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    flightId: $('#flightSelect').val(),
                    seatId: $('#seatSelect').val(),
                    paymentMethod: $('#paymentMethod').val(),
                    price: $('#totalPrice').val().replace('$', '')
                }),
                success: function(response) {
                    if (response.status === 'success') {
                        alert('Booking confirmed successfully!');
                        window.location.href = '/home';
                    } else {
                        alert('Booking failed: ' + response.message);
                    }
                },
                error: function() {
                    alert('An error occurred while booking');
                }
            });
        });
    });
    </script>
</body>
</html>